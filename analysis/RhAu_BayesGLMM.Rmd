---
title: Nest Success of Two Rhinoceros Auklet Colonies in the Salish Sea and California
  Current
author: "Eric Wagner, Eric Buhle, ..."
date: "April 21, 2019"
output:
  github_document:
    toc: true
    toc_depth: 3
  html_document:
    df_print: paged
    fig_caption: yes
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy = FALSE, highlight = TRUE, comment = NA, 
                      dev = "png", dev.args = list(type = "cairo-png"))

if(!require(captioner))
  devtools::install_github("adletaw/captioner")
library(captioner)
fig_nums <- captioner("Figure S", suffix = ": ", auto_space = FALSE, 
                      style = "b", style_prefix = TRUE)
```

```{r width, include=FALSE}
options(width = 130)
```

# Overview

This is a Rhinoceros Auklet from the Protection Island colony:

```{r auklet_image, out.width = "50%", echo = FALSE}
knitr::include_graphics("https://www.eopugetsound.org/sites/default/files/styles/magazinewidth_592px/public/topical_articles/images/16343412270_5cfaa5c480_o.jpg?itok=WjzI1_2K")
```

# Setup and data

First we load the libraries and functions we'll use.

```{r getting_started, message = FALSE, warning = FALSE}
if(!require(here)) install.packages("here::here")
library(here)
if(!require(rstanarm)) install.package("rstanarm")
library(rstanarm)
if(!require(bayesplot)) install.package("bayesplot")
library(bayesplot)
if(!require(Hmisc)) install.package("Hmisc")
library(Hmisc)
if(!require(sm)) install.package("sm")
library(sm)
if(!require(loo)) install.package("loo")
library(loo)
if(!require(denstrip)) install.package("denstrip")
library(denstrip)
if(!require(yarrr)) install.package("yarrr")
library(yarrr)
if(!require(corrplot)) install.package("corrplot")
library(corrplot)
if(!require(lubridate)) install.package("lubridate")
library(lubridate)
if(!require(tidyr)) install.package("tidyr")
library(tidyr)
if(!require(dplyr)) install.package("dplyr")
library(dplyr)
if(!require(gridExtra)) install.package("gridExtra")
library(gridExtra)
source(here::here("analysis","loo_compair.R"))
```

```{r load_saved_objects, echo = FALSE}
if(file.exists(here::here("analysis","cache","occ_stanfit_loo.RData"))) {
  load(here::here("analysis","cache","occ_stanfit_loo.RData"))
  refit_occ <- FALSE
} else refit_occ <- TRUE
if(file.exists(here::here("analysis","cache","suc_stanfit_loo.RData"))) {
  load(here::here("analysis","cache","suc_stanfit_loo.RData"))
  refit_suc <- FALSE
} else refit_suc <- TRUE
```

Next we'll read in the datasets from various sources and manipulate them into a usable format.

```{r data, message = FALSE, warning = FALSE}
# Nest success data
nest_data <- read.csv(here::here("data","RhAu2.csv"), fileEncoding="UTF-8-BOM")
names(nest_data) <- gsub("lastcheck", "last_check", tolower(names(nest_data)))

# PDO from ERSST V3b https://www.esrl.noaa.gov/psd/pdo/ Using EOF from 1920 to 2014 for N Pacific
# Monthly 1854-2019
pdo <- read.csv(here::here("data","pdo.timeseries.ersstv3b.csv"), na.strings = "-9999.000")
colnames(pdo)[2] <- "pdo"
pdo$Date <- ymd(pdo$Date)
pdo <- mutate(pdo, year = ifelse(month(Date) > 8, year(Date) + 1, year(Date)),
              month = month(Date, label = TRUE), Date = NULL)
pdo <- spread(pdo, month, pdo)
pdo <- select(pdo, c(year, Sep:Dec, Jan:Aug))
pdo <- data.frame(pdo, pdo_index = rowMeans(select(pdo, Nov:Mar)))

# MEI v.2 1979-2018
# Wide format: rows are years, columns are months
mei <- read.csv(here::here("data","MEIv2.csv"))
colnames(mei) <- tolower(colnames(mei))
mei <- gather(mei, months, mei, decjan:novdec)
mei <- mutate(mei, year = ifelse(months %in% c("sepoct","octnov","novdec"), year + 1, year))
mei <- spread(mei, months, mei)
mei <- select(mei, c(year,sepoct,octnov,novdec,decjan,
                     janfeb,febmar,marapr,aprmay,mayjun,junjul,julaug,augsep))
mei <- data.frame(mei, mei_avg = rowMeans(select(mei, sepoct:augsep)))

# Average monthly SST from DFO stations
# Wide format: year x month
sst_amph <- read.csv(here::here("data",grep("Amphitrite", list.files(here::here("data")), 
                                            value = TRUE)),
                     skip = 1, na.strings = "99.99")
colnames(sst_amph) <- tolower(colnames(sst_amph))
sst_amph <- mutate(sst_amph, sst_amph_spring = rowMeans(select(sst_amph, apr:jun)))

sst_race <- read.csv(here::here("data",grep("Race_Rocks", list.files(here::here("data")), 
                                            value = TRUE)),
                     skip = 1, na.strings = "99.99")
colnames(sst_race) <- tolower(colnames(sst_race))
sst_race <- mutate(sst_race, sst_race_spring = rowMeans(select(sst_race, apr:jun)))

# Coastal Upwelling Index 48N 125W 1946-2018
# Wide format: rows are years, columns are months
cui <- read.csv(here::here("data","CoastalUpwellingIndex.csv"))[,-1]
colnames(cui)[1] <- "year"
cui <- mutate(cui, cui_spring = rowMeans(select(cui, Apr:Jun)))

# Biological spring transition from NWFSC Ocean Ecosystem Indicators
# Long format, 1970-2018
biol_trans <- read.csv(here::here("data","biological_spring_transition_NWFSC.csv"),
                       skip = 10, na.strings = "Never ", stringsAsFactors = FALSE)
colnames(biol_trans) <- c("year","st_onset","st_end","st_duration")
biol_trans <- mutate(biol_trans, st_onset = yday(ydm(paste(year, st_onset, sep = "-"))))
biol_trans <- mutate(biol_trans, st_onset = replace_na(st_onset, 365), 
                     st_end = replace_na(st_end, 365))

# Area-Averaged of Sea Surface Temperature at 11 microns (Day) monthly 4 km [MODIS-Aqua ()
# at Protection and Destruction Island
# Monthly 2009-2018
sst_DI <- read.csv(here::here("data","SST_DI_2002_2019.csv"), skip = 8, 
                   na.strings = "-32767")[,1:2]
colnames(sst_DI) <- c("date","sst")
sst_DI$date <- mdy_hm(sst_DI$date)
sst_DI <- mutate(sst_DI, year = year(date), month = month(date, label = TRUE), date = NULL)
sst_DI <- spread(sst_DI, month, sst)
sst_DI <- mutate(sst_DI, sst_DI_spring = rowMeans(select(sst_DI, Apr:Jun)))

sst_PI <- read.csv(here::here("data","SST_PI_2002_2019.csv"), skip = 8, 
                   na.strings = "-32767")[,1:2]
colnames(sst_PI) <- c("date","sst")
sst_PI$date <- ymd_hms(sst_PI$date)
sst_PI <- mutate(sst_PI, year = year(date), month = month(date, label = TRUE), date = NULL)
sst_PI <- spread(sst_PI, month, sst)
sst_PI <- mutate(sst_PI, sst_PI_spring = rowMeans(select(sst_PI, Apr:Jun)))

#  Area-Averaged of Chlorophyll a concentration monthly 4 km [MODIS-Aqua MODISA_L3m_CHL v2018]
# at Protection and Destruction Island
# Monthly 2002-2019
chla_DI <- read.csv(here::here("data","Chla_DI_2002_2019.csv"), skip = 8, na.strings = "-32767")[,1:2]
colnames(chla_DI) <- c("date","chla")
chla_DI$date <- mdy_hm(chla_DI$date)
chla_DI <- mutate(chla_DI, year = year(date), month = month(date, label = TRUE), date = NULL)
chla_DI <- spread(chla_DI, month, chla)
chla_DI <- mutate(chla_DI, chla_DI_spring = rowMeans(select(chla_DI, Apr:Jun)))

chla_PI <- read.csv(here::here("data","Chla_PI_2002_2019.csv"), skip = 8, na.strings = "-32767")[,1:2]
colnames(chla_PI) <- c("date","chla")
chla_PI$date <- mdy_hm(chla_PI$date)
chla_PI <- mutate(chla_PI, year = year(date), month = month(date, label = TRUE), date = NULL)
chla_PI <- spread(chla_PI, month, chla)
chla_PI <- mutate(chla_PI, chla_PI_spring = rowMeans(select(chla_PI, Apr:Jun)))

# Merge covariate data
env_data <- Reduce(inner_join, list(select(pdo, c(year, pdo_index)), 
                                    select(mei, c(year, mei_avg)), 
                                    select(sst_DI, c(year, sst_DI_spring)), 
                                    select(sst_PI, c(year, sst_PI_spring)),
                                    select(sst_amph, c(year, sst_amph_spring)),
                                    select(sst_race, c(year, sst_race_spring)),
                                    select(cui, c(year, cui_spring)),
                                    select(chla_DI, c(year, chla_DI_spring)),
                                    select(chla_PI, c(year, chla_PI_spring)),
                                    select(biol_trans, c(year, st_onset, st_duration))))
```

# Principal Components Analysis of Oceanographic Indicators

Let's explore the patterns of (a)synchrony among the oceanographic indicators to see how severe the multicollinearity might be if they were used as raw regression inputs. 

```{r env_corrplot, fig.align = "center", fig.height = 7, fig.width = 7, dpi = 200, out.width = "75%", echo = FALSE}
dat <- select(env_data, c(pdo_index, mei_avg, sst_DI_spring, sst_PI_spring, 
                          cui_spring, st_onset, chla_DI_spring, chla_PI_spring))
colnames(dat) <- c("PDO","MEI","SST (DI)","SST (PI)","CUI","ST","Chl a (DI)", "Chl a (PI)")
corrplot(cor(dat, use = "pairwise"), method = "ellipse", diag = FALSE, tl.col = "black")
```

Now we perform a principal components analysis to extract the major trends in the suite of oceanographic indicators for use as regression inputs.

```{r PCA, message = FALSE}
pca_env <- prcomp(~ pdo_index + mei_avg + sst_DI_spring + sst_PI_spring + 
                    cui_spring + chla_DI_spring + chla_PI_spring + st_onset, 
                  data = env_data, scale = TRUE)

pca_env            # rotation matrix gives the loadings
summary(pca_env)   # proportion of variance associated with each PC

## Add PC1 and PC2 to covariate data
scores <- predict(pca_env, newdata = env_data)
env_data <- data.frame(env_data, PC1 = scale(scores[,"PC1"]), PC2 = scale(scores[,"PC2"]))

## Merge PC1 and PC2 into nest data
rhau <- left_join(nest_data, select(env_data, c(year, PC1, PC2)))
```
```{r PCA_plots, fig.align = "center", fig.height = 7, fig.width = 7, dpi = 300, out.width = "75%", echo = FALSE}
par(mfcol = c(2,2))
# scree plot
imp <- summary(pca_env)$importance["Proportion of Variance",]
barplot(imp, xlab = "", ylab = "Proportion of variance", names.arg = names(imp))   
# biplot of PCAs and oceanographic indicators
biplot(pca_env) 
# PC1 loadings
xloc <- barplot(pca_env$rotation[,"PC1"], xaxt = "n", main = "PC1 loadings")
text(xloc, par("usr")[3], labels = dimnames(pca_env$rotation)[[1]], adj = c(1,1), srt = 45, 
     xpd = TRUE)
# PC2 loadings
xloc <- barplot(pca_env$rotation[,"PC2"], xaxt = "n", main = "PC2 loadings")
text(xloc, par("usr")[3], labels = dimnames(pca_env$rotation)[[1]], adj = c(1,1), srt = 45, 
     xpd = TRUE)
```
```{r env_timeseries_plots, fig.align = "center", fig.height = 10, fig.width = 5, dpi = 300, out.width = "50%", echo = FALSE}
## Time-series plots of indicators and PCs
par(mfrow = c(7,1), mar = c(1,5,1.2,4.5), oma = c(3,0,0,0))
vars <- c("pdo_index","mei_avg","sst_DI_spring","sst_PI_spring","cui_spring","st_onset",
          "chla_DI_spring","chla_PI_spring","PC1","PC2")
cols <- c("purple","red","darkred","salmon","darkblue","SpringGreen","darkgreen","lightgreen",
          "black","darkgray")
mfgs <- c(1,2,3,3,4,5,6,6,7,7)
ylabs <- c("PDO","MEI",bquote("SST (" * degree * "C)"), "CUI", "ST", 
           bquote("Chl " * italic(a) * " (mg/m" ^3 * ")"), "PC")
for(i in unique(mfgs)) {
  plot(env_data$year, env_data[,vars[match(i,mfgs)]], type = "l", lwd = 2, col = cols[match(i,mfgs)], 
       cex.axis = 1.2, cex.lab = 1.5, xlab = "", ylab = ylabs[i], 
       ylim = range(env_data[,vars[which(mfgs == i)]], na.rm = TRUE), 
       yaxt = "n", bty = "n")
  axis(side = 1, at = env_data$year[env_data$year %% 5 != 0], labels = FALSE, cex.axis = 1.2)
  ytck <- axisTicks(par("usr")[3:4], log = FALSE, nint = 3)
  axis(side = 2, at = ytck, las = 1, cex.axis = 1.2,
       labels = if(ylabs[[i]] == "ST") month(as_date(ytck), label = TRUE, abbr = TRUE) else ytck)
  mtext(ifelse(par("mfg")[1] == 7, "Year", ""), side = 1, line = 3, cex = 1.5*par("cex"))
  if(sum(mfgs == i) == 2) {
    lines(env_data$year, env_data[,vars[which(mfgs==i)[2]]], lwd = 2, col = cols[which(mfgs==i)[2]])
    legend("right", legend = if(ylabs[i] == "PC") 1:2 else c("DI","PI"), 
           inset = c(-0.15,0), xpd = TRUE, lwd = 2, col = cols[which(mfgs == i)], bty = "n")
  }
}
```

# GLMMs of Burrow Occupancy

Now we are ready to start fitting some GLMMs to the burrow occupancy data...[more on modeling, explanations of each model]

```{r fit_occ0, eval = refit_occ}
## Random effects of site and year

# Intercept-only model 
occ0 <- stan_glmer(cbind(egg, viable - egg) ~ (1 | site) + (1 | year),
                   data =  rhau,
                   family = binomial(link = logit),
                   prior_intercept = normal(0,5),
                   prior_covariance = decov(),
                   chains = 3, iter = 2000, warmup = 1000, cores = 3)
```
```{r summary_occ0}
summary(occ0, prob = c(0.025,0.5,0.975), digits = 2)
```


```{r fit_occ1, eval = refit_occ}
# Inter-island differences, constant across years
occ1 <- stan_glmer(cbind(egg, viable - egg) ~ island + (1 | site) + (1 | year),
                   data =  rhau,
                   family = binomial(link = logit),
                   prior = normal(0,5),
                   prior_intercept = normal(0,5),
                   prior_covariance = decov(),
                   chains = 3, iter = 2000, warmup = 1000, cores = 3)
```
```{r summary_occ1}
summary(occ1, prob = c(0.025,0.5,0.975), digits = 2)
```

```{r fit_occ2, eval = refit_occ}
# Inter-island differences, varying among years
occ2 <- stan_glmer(cbind(egg, viable - egg) ~ island + (1 | site) + (island | year),
                   data =  rhau,
                   family = binomial(link = logit),
                   prior = normal(0,5),
                   prior_intercept = normal(0,5),
                   prior_covariance = decov(),
                   chains = 3, iter = 2000, warmup = 1000, cores = 3)
```

```{r summary_occ2}
summary(occ2, prob = c(0.025,0.5,0.975), digits = 2)
```

```{r fit_occ3, eval = refit_occ}
# Inter-island differences, varying among years, plus PC1 + PC2
occ3 <- stan_glmer(cbind(egg, viable - egg) ~ island + PC1 + PC2 + (1 | site) + (island | year),
                   data =  rhau,
                   family = binomial(link = logit),
                   prior = normal(0,5),
                   prior_intercept = normal(0,5),
                   prior_covariance = decov(),
                   chains = 3, iter = 2000, warmup = 1000, cores = 3)
```

```{r summary_occ3}
summary(occ3, prob = c(0.025,0.5,0.975), digits = 2)
```

```{r fit_occ4, eval = refit_occ}
# Inter-island differences plus PC1 + PC2, no random time-variation
occ4 <- stan_glmer(cbind(egg, viable - egg) ~ island + PC1 + PC2 + (1 | site),
                   data =  rhau,
                   family = binomial(link = logit),
                   prior = normal(0,5),
                   prior_intercept = normal(0,5),
                   prior_covariance = decov(),
                   chains = 3, iter = 2000, warmup = 1000, cores = 3)
```

```{r summary_occ4}
summary(occ4, prob = c(0.025,0.5,0.975), digits = 2)
```

We compare the expected out-of-sample predictive performance of the candidate models using the Bayesian Pareto-smoothed approxiamte leave-one-out cross-validation score...

```{r loo_occ, eval = refit_occ}
## Model selection by approximate leave-one-out cross-validation
occ_loos <-  lapply(list(occ0 = occ0, occ1 = occ1, occ2 = occ2, occ3 = occ3, occ4 = occ4), loo)

# unpaired comparisons
occ_compare <- loo_compare(occ_loos)

# pairwise comparisons
occ_compair <- loo_compair(occ_loos)
```

```{r print_loo_occ}
occ_loos
print(occ_compare, simplify = FALSE)
occ_compair
```

If we have refit the models, we cache the results to save time...

```{r cache_occ, eval = !refit_occ}
## Cache stanfits and loo objects
save(list = grep("occ", ls(), value = TRUE), file = here::here("analysis","cache","occ_stanfit_loo.RData"))
```



